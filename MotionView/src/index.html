<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PROS Path Viewer (Offline)</title>
  <link rel="stylesheet" href="styles.css" />
  <script type="module" src="/main.js" defer></script>
</head>
<body>
<header class="">
  <input id="file" type="file" accept=".json" style="display:none" />
  <input id="robotImageFile" type="file" accept="image/*" style="display:none" />
  <button id="btnSettings" class="iconBtn" title="Settings">‚öôÔ∏è</button>
  <button id="btnFile" class="iconBtn" title="Open JSON">üìÑ</button>
  <button id="btnPlay" class="iconBtn" title="Play/Pause" disabled>‚ñ∂</button>
  <div class="chip">
    <span class="muted">Speed</span>
    <select id="speedSelect" title="Playback Speed Changer">
      <option value="0.25">0.25√ó</option>
      <option value="0.5">0.5√ó</option>
      <option value="1" selected>1√ó</option>
      <option value="2">2√ó</option>
      <option value="4">4√ó</option>
      <option value="8">8√ó</option>
    </select>
  </div>
  <button id="btnFit" class="iconBtn" title="Maximize field (square)">‚§¢</button>
  <button id="btnToggleFloat" class="iconBtn" title="Toggle Info Window">üìã</button>
  <div class="chip">
    <span class="muted">Field</span>
    <select id="fieldSelect" title="Field image Selector">
      <option value="">No field image</option>
    </select>
  </div>
  <button class="iconBtn pillAction" id="btnClearField" style="font-size: 12px" title="Clear field">‚ùå</button>
  <button id="btnHelp" class="iconBtn" title="Help">?</button>
  <span class="grow muted" id="status">Drop a viewer JSON file.</span>
</header>

<div id="helpModal" class="modal" hidden>
  <div class="modalBackdrop"></div>
  <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="helpTitle">
    <div class="modalHeader">
      <div id="helpTitle" style="font-weight:900;font-size:16px">JerryForge Viewer ‚Äî Help</div>
      <button id="btnHelpClose" class="iconBtn" title="Close">‚úï</button>
    </div>
    <div class="modalBody">
      <p style="margin-top:0">
        This is an offline viewer for robot logs produced by the JerryForge / SfxLib PROS library.
      </p>
      <p>
        Use it with JSON files generated by:
        <a href="https://github.com/lewispinstein-hue/PROS-JerryForge-Logger-Demo/tree/main/tools/JerryForge" target="_blank" rel="noreferrer">
          PROS-JerryForge-Logger-Demo
        </a>
      </p>
      <div style="margin-top:10px">
        <div style="font-weight:850;margin-bottom:6px">Main elements</div>
        <ul style="margin:0;padding-left:18px">
          <li><b>Field view</b>: robot path + pose, watches, hover/click to preview/lock.</li>
          <li><b>Timeline</b>: scrub through time; hover previews, click jumps.</li>
          <li><b>Sidebar</b>: watches list, poses list.</li>
          <li><b>Floating info window</b>: shows details of hovered point, including closest watch values.</li>
        </ul>
      </div>
      <div style="margin-top:10px" class="muted">
        Tip: Drag the thin handles to resize/collapse the sidebar (left) and timeline (bottom).
      </div>
    </div>
  </div>
</div>

<div id="settingsModal" class="modal" hidden>
  <div class="modalBackdrop"></div>
  <div class="modalCard" role="dialog" aria-modal="true" aria-labelledby="settingsTitle" tabindex="-1" style="max-width: 600px;">
    <div class="modalHeader">
      <div id="settingsTitle" style="font-weight:900;font-size:16px">Settings</div>
      <button id="btnSettingsClose" class="iconBtn" title="Close">‚úï</button>
    </div>
    <div class="modalBody">
      <div style="margin-bottom:20px">
        <label style="display:block;margin-bottom:6px;font-weight:700">PROS Directory (optional, needed for live viewing)</label>
        <div style="display:flex;gap:8px;align-items:center">
          <input id="prosDirInput" type="text" placeholder="/path/to/pros/project" style="flex:1" />
          <button id="btnProsDirBrowse" class="iconBtn" style="font-size:12px">Browse</button>
        </div>
          <div id="prosDirStatus" class="muted" style="margin-top:4px;font-size:11px">Set the PROS project directory for live viewing functionality</div>
        </div>

      <div class="divider" style="margin:20px 0;"></div>

      <div style="margin-bottom:20px">
        <div style="font-weight:800;margin-bottom:12px">Robot Image</div>
        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
          <button id="btnUploadRobotImage" class="iconBtn" style="font-size:12px">Upload Image</button>
          <label style="display:flex;align-items:center;gap:8px;cursor:pointer">
            <input id="robotImageToggle" type="checkbox" style="width:18px;height:18px;cursor:pointer" />
            <span>Show robot image</span>
          </label>
        </div>
        <div id="settingsRobotImgControls" style="margin-top:12px" hidden>
          <div class="grid2">
            <div>
              <label>Img Scale</label>
              <input id="settingsRobotImgScale" type="number" step="0.05" value="1" />
            </div>
            <div>
              <label>Img X Off</label>
              <input id="settingsRobotImgOffX" type="number" step="0.25" value="0" />
            </div>
            <div>
              <label>Img Y Off</label>
              <input id="settingsRobotImgOffY" type="number" step="0.25" value="0" />
            </div>
            <div>
              <label>Img Rot (¬∞)</label>
              <input id="settingsRobotImgRot" type="number" step="1" value="0" />
            </div>
          </div>
        </div>
      </div>

      <div class="divider" style="margin:20px 0;"></div>

      <div style="margin-bottom:20px">
        <div style="font-weight:800;margin-bottom:12px">Units & Robot Size</div>
        <div class="grid2">
          <div>
            <label>Units (interpret input poses as)</label>
            <select id="settingsUnitsSelect">
              <option value="in">inches</option>
              <option value="cm">centimeters</option>
              <option value="ft">foot</option>
              <option value="tiles">tiles (24 in)</option>
            </select>
          </div>
          <div>
            <label>Field rotation</label>
            <select id="settingsFieldRotation">
              <option value="0">0¬∞</option>
              <option value="90">90¬∞</option>
              <option value="180">180¬∞</option>
              <option value="270">270¬∞</option>
            </select>
          </div>
          <div>
            <label>Robot size (inches on field)</label>
            <div class="grid2">
              <input id="settingsRobotW" type="number" step="1" value="12" />
              <input id="settingsRobotH" type="number" step="1" value="12" />
            </div>
            <div class="muted" style="margin-top:6px">width / height</div>
          </div>
        </div>
      </div>

      <div class="divider" style="margin:20px 0;"></div>

      <div style="margin-bottom:20px">
        <div style="font-weight:800;margin-bottom:12px">Offsets</div>
        <div class="grid3">
          <div>
            <label>X Offset</label>
            <input id="settingsOffX" type="number" step="0.1" value="0" />
          </div>
          <div>
            <label>Y Offset</label>
            <input id="settingsOffY" type="number" step="0.1" value="0" />
          </div>
          <div>
            <label>Theta Offset</label>
            <input id="settingsOffTheta" type="number" step="1" value="0" />
          </div>
        </div>
      </div>

      <div class="divider" style="margin:20px 0;"></div>

      <div style="margin-bottom:20px">
        <div style="font-weight:800;margin-bottom:12px">Speed Normalization</div>
        <div class="grid2">
          <div>
            <label>Min speed (normalize)</label>
            <input id="settingsMinSpeed" type="number" title="Minimum speed used for color normalization (red=slow)" step="1" value="0" />
          </div>
          <div>
            <label>Max speed (normalize)</label>
            <input id="settingsMaxSpeed" type="number" title="Maximum speed used for color normalization (green=fast)" step="1" value="127" />
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div id="floatingInfo" class="hidden">
  <div id="floatHeader">
    <div class="float-title">
      <span class="float-title-text">Point Details</span>
      <span class="float-subtitle" id="fcount">Point: ‚Äî/‚Äî</span>
    </div>
    <button id="btnCloseFloat" class="iconBtn" aria-label="Close">‚úï</button>
  </div>

  <div id="floatBody">
    <div class="float-section">
      <div class="float-row"><span class="k">X</span><span class="v" id="fx">‚Äî</span></div>
      <div class="float-row"><span class="k">Y</span><span class="v" id="fy">‚Äî</span></div>
      <div class="float-row"><span class="k">Œ∏</span><span class="v" id="ft">‚Äî</span></div>
    </div>

    <div class="divider"></div>

    <div class="float-section">
        <div class="float-row"><span class="k">Time</span><span class="v" id="ftime">‚Äî</span></div>
        <div class="float-row"><span class="k">Œî</span><span class="v" id="fdeltat">‚Äî</span></div>
    </div>

    <div class="divider"></div>

    <div class="float-section">
      <div class="float-row"><span class="k">Avg Vel</span><span class="v" id="favg">‚Äî</span></div>
      <div class="float-row"><span class="k">L Vel</span><span class="v" id="flv">‚Äî</span></div>
      <div class="float-row"><span class="k">R Vel</span><span class="v" id="frv">‚Äî</span></div>
    </div>
    <div class="divider"></div>

    <div class="float-watch" id="fwatchblock">
      <div class="float-watch-head">
        <span class="chip" id="fwatchclickable">Closest Watch</span>
        <span class="float-watch-time" id="fwatchtime">‚Äî</span>
      </div>

      <div class="float-row"><span class="k">Label</span><span class="v v-soft" id="fwatchlabel">‚Äî</span></div>
      <div class="float-row"><span class="k">Value</span><span class="v v-soft" id="fwatchvalue">‚Äî</span></div>
    </div>
  </div>

  <div id="floatResizer" aria-hidden="false"></div>
</div>


<div class="app">
  <div class="row">

    <div id="left">
      <div class="leftTopBar">
        <div class="leftTopRow">
          <button class="iconBtn pillAction" id="btnLeftStop" title="Stop">Stop</button>
          <button class="iconBtn pillAction" id="btnLeftConnect" title="Connect">Connect</button>

          <div></div>

          <div class="leftRefreshChip" title="Refresh + interval">
            <button class="leftRefreshBtn" id="btnLeftRefresh" type="button">Refresh</button>
            <select id="leftRefreshInterval" aria-label="Refresh interval">
              <option value="0">off</option>
              <option value="100">100ms</option>
              <option value="121">121ms (SFX HZ)</option>
              <option value="250">250ms</option>
              <option value="500" selected>500ms</option>
              <option value="1000">1s</option>
              <option value="2000">2s</option>
              <option value="5000">5s</option>
            </select>
          </div>
        </div>
      </div>

      <div class="leftBody">
        <textarea id="liveWin" class="monoText" readonly wrap="soft" spellcheck="false" aria-label="Live window"></textarea>
      </div>
    </div>

    <div id="vSplitL" class="splitterV" title="Drag to resize"></div>

    <div id="canvasWrap">
      <canvas id="c"></canvas>
    </div>

    <div id="vSplit" class="splitterV" title="Drag to resize"></div>

    <div id="right">
      <div class="section">
        <div class="statsPanel">
          <div class="statsHeader">
            <div class="statsTitle">Stats</div>
            <div class="statsHint" id="statsMarker">Updates when a path is loaded</div>
          </div>
          <div class="kvs" id="stats"></div>
        </div>
      </div>

      <div class="section">
        <details open id="secWatches">
          <summary>
            <span>Watches</span>
            <span class="pill" id="watchCount">‚Äî</span>
          </summary>
          <div class="detailsBody">
            <div class="rowline" style="margin-bottom:8px">
              <span class="muted">Sort</span>
              <select id="watchSort" style="margin-left:auto">
                <option value="level">level</option>
                <option value="time" selected>time</option>
                <option value="-time">-time</option>
                <option value="value">value</option>
              </select>
            </div>

            <div id="watchList"></div>
            <div class="muted" style="margin-top:10px">
              Click a watch to highlight it on the field and on the timeline.
            </div>
          </div>
        </details>
      </div>

      
      <div class="section">
        <details open id="secPoses">
          <summary>
            <span>Poses</span>
            <span class="pill" id="poseCount">‚Äî</span>
          </summary>
          <div class="detailsBody">
            <div class="muted" style="margin-bottom:8px">Click a pose to jump.</div>
            <div id="poseList" title="Click a pose to jump the robot to that recorded moment" style="max-height: 40vh; overflow:auto; border:1px solid var(--line); border-radius:10px;"></div>
          </div>
        </details>
      </div>

    </div>
  </div>

  <div id="hSplit" class="splitterH" title="Drag to resize timeline"></div>

  <!-- Bottom timeline bar -->
  <div id="timelineBar">
    <div id="timelineTop">
      <div id="timelineLeft">
        <span class="pill" id="timePill">Time: ‚Äî</span>
        <span class="pill" id="deltaPill">Œî: ‚Äî</span> 
        <span class="pill" id="pointPill">Point: ‚Äî/‚Äî</span>
      </div>
      <span class="pill poseReadout" id="posePill">
        <span class="kv"><span class="k">X: </span><span class="v" id="poseX">‚Äî</span></span>
        <span class="kv"><span class="k">Y: </span><span class="v" id="poseY">‚Äî</span></span>
        <span class="kv"><span class="k">Œ∏: </span><span class="v" id="poseTh">‚Äî</span></span>
        <span class="kv"><span class="k">Speed: </span><span class="v" id="poseSn">‚Äî</span></span>
      </span>
    </div>
    <canvas id="timelineCanvas"></canvas>
    <div id="timelineHint" class="muted">
      Hover: preview robot at time ‚Ä¢ Click: set time ‚Ä¢ Watch dots are clickable
    </div>
  </div>
</div>
<div id="watchPopup" hidden></div>
</body>
</html>
